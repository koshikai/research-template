# marimo ノートブック構文ルール (公式チュートリアル準拠)

このプロジェクトで marimo ノートブックを作成・更新する際の
**構文ルール**と**設計上の原則**です。公式チュートリアルの構成を
ベースに整理しています。

## 1. 基本構成
- ファイル形式は **純粋な Python (.py)**。
- 先頭付近は以下の形を基本とする:
  - `import marimo`
  - `__generated_with = "x.y.z"` (生成ツールが書く場合は残す)
  - `app = marimo.App(...)`
- 必要に応じて **PEP 723 の script metadata** を先頭に書く:
  - 例: `# /// script` ブロックで依存関係を列挙
  - `--sandbox` 実行やノートブック単位の依存管理で有効
- 必要に応じて `with app.setup:` を使い、**非リアクティブな初期化**や
  セットアップ処理をまとめる。

## 2. セル構文
- セルは `@app.cell` デコレータ付きの関数で表現する。
- 関数名は `_` を基本とし、可読性が必要なら意味のある名前も可。
- **引数 = refs** (参照するグローバル変数)  
  **戻り値 = defs** (次のセルに渡したい変数)
- **見せたい変数は return する**。返さないと他セルから参照できない。
- 表示目的のセルは、`mo.md()` などの出力オブジェクトを**セル出力に含める**
  (最後の式に置くか return する)。
- `@app.cell(hide_code=True)` を使って説明セルを非表示にできる。

## 3. 依存関係と命名
- **グローバル名は一意**。同名の変数を複数セルで定義しない。
- `_` で始まる変数は **セル内ローカル扱い**で、重複定義可能。
- **セル順序は実行順序ではない**。依存関係が実行順を決める。

## 4. UI / 表示の基本
- `import marimo as mo` は **セル内で行い**、`mo` を return して共有する。
- UI要素は `mo.ui.*` で生成し、**グローバル変数に代入**する。
  - 代入しないとリアクティブ実行のトリガにならない。
- UI値は `.value` で参照する。
- 表示は `mo.md()` を基本とし、f-string で UI を埋め込める。

## 4.1 追加の作法 (表示と分岐)
- セルは **Python関数**として書くが、marimo は defs/refs を静的解析する。
  **defs は常に同じ集合**になるようにし、条件分岐で `return` を変えない。
  - 例: `value = None` を先に置き、分岐後に `return value`
- `mo.md` / `mo.ui.*` は **出力として表示**させる必要がある。
  - 最も確実なのは「最後の式に置く」か「return する」こと。
- UIは「作るセル」と「見せるセル」を分けても良い。
  - ただし見せるセルの出力に UI を含めること。
- UIが表示されない典型原因:
  - UIオブジェクトを出力に含めていない
  - 条件分岐で UI 生成自体がスキップされている
  - 依存データ欠如や例外でセルが途中終了している

## 5. 実行エントリ
- スクリプトとして実行可能にするために以下を付ける:
  - `if __name__ == "__main__": app.run()`

## 5.1 卒論ボードから抽出した実践パターン
- **ブートストラップセル**:
  - `bootstrap_project()` で `project_root` を取得してから他セルで使う。
  - 保存先や相対パスの基準にする。
- **依存インポートの集約**:
  - 解析・描画・実験セットアップを 1 セルに集約し、必要な値を return する。
  - 任意依存 (例: matplotlib) は `try/except` で安全に読み込む。
- **UIセルとレイアウトセルを分離**:
  - UIは生成セルで作り、`mo.sidebar(mo.vstack(...))` などのレイアウトセルで
    **表示**する。
  - UIを表示しないと反映されないため、必ず出力に含める。
- **実行トリガは `mo.ui.run_button` で制御**:
  - 長い処理は `run_button.value` を条件に `mo.stop` でガードする。
  - 「ボタンを押してください」等の callout を出す。
- **重い処理は spinner で囲む**:
  - `with mo.status.spinner("学習中..."):` で実行中を明示する。
- **解析は例外保護**:
  - 解析セルは `try/except` で `analysis_error` を返し、
    UI側で callout 表示する。
- **図の表示は `mo.as_html(fig)`**:
  - `None` の場合は代替メッセージを表示する。
- **保存フローは UI + ガード**:
  - `mo.ui.text` で保存先を入力、`run_button` で保存を実行。
  - `mo.stop` で前提条件をチェックし、保存結果を callout で表示する。

## 6. 本プロジェクトの運用規約
- ノートブックは `notebooks/` 配下に配置する。
- 変更後は以下を必ず実行する:
  - `uv run --group dev marimo check notebooks/your_notebook.py`
  - `uv run --group dev poe ui-check -- --notebook notebooks/your_notebook.py`
- UIチェックが成功したら **「できました」** と報告する。
